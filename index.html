<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIV Live Board - Forced Sync</title>
    <style>
        :root {
            --bg-deep: #0a0a0c; --text-main: #ffffff; --accent-blue: #00aaff;
            --station-yellow: #ffee00; --status-green: #00ff88; --status-orange: #ffa500;
            --std-class-grey: #333;
        }
        body { background-color: #000; color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .board { max-width: 1000px; margin: auto; background: var(--bg-deep); padding: 25px; border-radius: 12px; border: 1px solid #222; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 10px; }
        #station-name { font-size: 2rem; color: var(--station-yellow); font-weight: bold; }
        #clock { font-size: 2rem; font-family: monospace; }
        .status-pill { padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; margin-top: 10px; display: inline-block; }
        .live { background: #004422; color: var(--status-green); }
        .fail { background: #441111; color: #ff6666; }
        .service-row { padding: 20px 0; border-bottom: 1px solid #1a1a1a; }
        .main-line { display: flex; font-size: 1.5rem; font-weight: bold; justify-content: space-between; }
        .dest { flex-grow: 1; margin: 0 20px; }
        .marquee { color: #888; margin-top: 10px; font-size: 1rem; overflow: hidden; white-space: nowrap; }
        #error-log { background: #1a1100; color: #ffcc00; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem; margin-top: 15px; display: none; }
    </style>
</head>
<body>

<div class="board">
    <div class="header">
        <div>
            <div id="station-name">Liverpool Lime Street</div>
            <div id="status-display" class="status-pill fail">Connecting...</div>
        </div>
        <div id="clock">00:00:00</div>
    </div>
    
    <div id="services-list">Handshaking with National Rail...</div>
    
    <div id="error-log"></div>
</div>

<script>
    const TOKEN = 'OY6k1qcYgWZxxesIXJQbIkO2UXyAnVmrVDpkljOBUc0uzCKL';
    const STATION = 'LIV';

    async function fetchData() {
        const list = document.getElementById('services-list');
        const status = document.getElementById('status-display');
        const errLog = document.getElementById('error-log');

        // CACHE BUSTER: We add a random number to the URL so the proxy can't use an old, failed result
        const buster = Math.floor(Math.random() * 9999);
        const url = `https://huxley2.azurewebsites.net/departures/${STATION}?accessToken=${TOKEN}&expand=true&cb=${buster}`;

        try {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Server Error: ${response.status}. This usually means your key is still 'Syncing' at National Rail.`);
            }

            const data = await response.json();

            if (data && data.trainServices) {
                status.innerText = "Live Network Connected";
                status.className = "status-pill live";
                errLog.style.display = "none";
                render(data.trainServices);
            } else {
                throw new Error("Connected, but no train data returned. (Check if it's late night/no trains scheduled).");
            }

        } catch (e) {
            status.innerText = "Connection Failed";
            status.className = "status-pill fail";
            errLog.innerText = `Diagnostic Info: ${e.message}`;
            errLog.style.display = "block";
            list.innerHTML = "<div style='color:#666'>Waiting for data link...</div>";
        }
    }

    function render(services) {
        const container = document.getElementById('services-list');
        container.innerHTML = '';
        services.forEach(s => {
            const row = document.createElement('div');
            row.className = 'service-row';
            const callingPoints = s.subsequentCallingPoints ? s.subsequentCallingPoints[0].callingPoint.map(p => p.locationName).join(' â€¢ ') : "Calling at all stations.";
            
            row.innerHTML = `
                <div class="main-line">
                    <div style="width:80px">${s.std}</div>
                    <div class="dest">${s.destination[0].locationName}</div>
                    <div style="width:50px; text-align:center">${s.platform || '-'}</div>
                    <div style="width:120px; text-align:right; color:${s.etd === 'On Time' ? '#00ff88' : '#ffa500'}">${s.etd}</div>
                </div>
                <div class="marquee">${callingPoints}</div>
            `;
            container.appendChild(row);
        });
    }

    // Update clock
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
    }, 1000);

    // Initial fetch and auto-refresh every 60 seconds
    fetchData();
    setInterval(fetchData, 60000);
</script>
</body>
</html>
